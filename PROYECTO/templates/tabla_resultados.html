<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados en Tiempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .match-ok { background-color: #dcfce7; color: #166534; font-weight: 600; }
        .match-fail { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
        
        /* Animación personalizada para filas actualizadas */
        @keyframes highlight {
            0% { background-color: #e0f2fe; }
            100% { background-color: transparent; }
        }
        .updated-row {
            animation: highlight 1.5s ease-out;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <header class="bg-white shadow sticky top-0 z-50">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-slate-900">Validación en Vivo</h1>
                <span id="progress-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800 animate-pulse">
                    Procesando...
                </span>
            </div>
            
            <div class="flex gap-3">
                <button onclick="copyAllReniec()" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold py-2 px-4 rounded shadow flex items-center gap-2 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 012-2h2a2 2 0 012 2m-6 4h6m-6 4h6" />
                    </svg>
                    Copiar Todo RENIEC
                </button>
                <a href="/" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm font-semibold py-2 px-4 rounded shadow flex items-center transition">
                    Nueva Consulta
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-[98%] mx-auto py-6">
        <div class="bg-white shadow-xl rounded-lg overflow-hidden border border-slate-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200" id="results-table">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">DNI</th>
                            <!-- Inputs -->
                            <th class="px-4 py-3 text-center text-xs font-bold text-blue-600 uppercase bg-blue-50 border-l border-blue-100">Nombre (Input)</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-blue-600 uppercase bg-blue-50">Paterno (Input)</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-blue-600 uppercase bg-blue-50 border-r border-blue-100">Materno (Input)</th>
                            <!-- API -->
                            <th class="px-4 py-3 text-center text-xs font-bold text-emerald-600 uppercase bg-emerald-50 border-l border-emerald-100 w-1/6">Nombre (RENIEC)</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-emerald-600 uppercase bg-emerald-50 w-1/6">Paterno (RENIEC)</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-emerald-600 uppercase bg-emerald-50 border-r border-emerald-100 w-1/6">Materno (RENIEC)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        {{ range .Resultados }}
                        <tr id="row-{{ .ID }}" class="transition-colors">
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-mono text-slate-900 border-r border-slate-100">
                                {{ .DNI }}
                            </td>
                            <!-- Inputs (Estáticos por ahora) -->
                            <td class="px-4 py-3 text-sm text-center text-slate-400">{{ .NombreInput }}</td>
                            <td class="px-4 py-3 text-sm text-center text-slate-400">{{ .PaternoInput }}</td>
                            <td class="px-4 py-3 text-sm text-center text-slate-400 border-r border-slate-200">{{ .MaternoInput }}</td>

                            <!-- API Placeholders Animados -->
                            <td colspan="3" class="px-4 py-3 text-center bg-slate-50">
                                <div class="flex items-center justify-center gap-2 text-slate-400 animate-pulse">
                                    <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="text-xs font-semibold">Validando...</span>
                                </div>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Scripts de Lógica Cliente -->
    <script>
        let completedCount = 0;
        const totalCount = {{ .Total }};

        // Función llamada por el servidor cuando termina una fila
        function updateRow(id, htmlContent, hasError) {
            const row = document.getElementById(`row-${id}`);
            if (row) {
                row.innerHTML = htmlContent;
                row.classList.add('updated-row'); // Flash effect
                
                // Marcar fila como "válida" para el copiado masivo si no tiene error
                if (!hasError) {
                    row.dataset.valid = "true";
                }
            }
            
            updateProgress();
        }

        function updateProgress() {
            completedCount++;
            const badge = document.getElementById('progress-badge');
            if (completedCount >= totalCount) {
                badge.classList.remove('bg-blue-100', 'text-blue-800', 'animate-pulse');
                badge.classList.add('bg-green-100', 'text-green-800');
                badge.textContent = "✓ Completado";
            } else {
                badge.textContent = `Procesando ${completedCount}/${totalCount}...`;
            }
        }

        // Copiar fila individual (Nombre \t Paterno \t Materno)
        function copyRow(id) {
            const nom = document.getElementById(`nom-${id}`).innerText;
            const pat = document.getElementById(`pat-${id}`).innerText;
            const mat = document.getElementById(`mat-${id}`).innerText;
            
            const textToCopy = `${nom}\t${pat}\t${mat}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast("Fila copiada al portapapeles");
            });
        }

        // Copiar TODO lo que sea válido (RENIEC Data)
        function copyAllReniec() {
            let buffer = "";
            let count = 0;
            
            // Iterar sobre todas las filas procesadas
            for (let i = 0; i < totalCount; i++) {
                const row = document.getElementById(`row-${i}`);
                // Solo si la fila tiene datos válidos (elementos existen)
                const nomEl = document.getElementById(`nom-${i}`);
                const patEl = document.getElementById(`pat-${i}`);
                const matEl = document.getElementById(`mat-${i}`);

                if (nomEl && patEl && matEl) {
                    const nom = nomEl.innerText.trim();
                    if (nom !== "") { // Evitar vacíos o errores
                        buffer += `${nom}\t${patEl.innerText}\t${matEl.innerText}\n`;
                        count++;
                    }
                }
            }

            if (buffer) {
                navigator.clipboard.writeText(buffer).then(() => {
                    showToast(`Copiados ${count} registros válidos`);
                });
            } else {
                alert("No hay datos válidos para copiar aún.");
            }
        }

        // Simple Toast Notification
        function showToast(msg) {
            const toast = document.createElement("div");
            toast.className = "fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-2 rounded shadow-lg text-sm z-50 transition-opacity duration-500";
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 2000);
        }
    </script>
</body>
</html>